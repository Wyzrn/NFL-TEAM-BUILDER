{% extends 'base.html' %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/team_form.css' %}">

{% block content %}
<h1>Create a Team</h1>
<form method="post">
  {% csrf_token %}
  <label>Team Name: <input type="text" name="team_name" required></label>
  <div class="team-create-container">
    <div class="team-roster">
      <h2>Your Roster</h2>
      {% for slot, label in roster_slots %}
        <div class="roster-slot" style="margin-bottom: 1em;">
          <strong>{{ label }}</strong><br>
          <input type="hidden" name="slot_{{ slot }}" id="slot_{{ slot }}">
          <div id="slot_display_{{ slot }}">
            <em>Empty</em>
          </div>
        </div>
      {% endfor %}
    </div>
    <div class="team-player-list">
      <h2>All Players</h2>
      <form id="player-search-form" method="get">
        <input type="text" name="q" value="{{ q }}" placeholder="Search players...">
        <select name="position">
          <option value="">All Positions</option>
          {% for pos in positions %}
            <option value="{{ pos }}" {% if pos == selected_position %}selected{% endif %}>{{ pos }}</option>
          {% endfor %}
        </select>
        <select name="team">
          <option value="">All Teams</option>
          {% for t in teams %}
            <option value="{{ t }}" {% if t == selected_team %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
        <select name="sort">
          <option value="name" {% if sort == 'name' %}selected{% endif %}>Sort by Name</option>
          <option value="position" {% if sort == 'position' %}selected{% endif %}>Sort by Position</option>
          <option value="team" {% if sort == 'team' %}selected{% endif %}>Sort by Team</option>
        </select>
        <button type="submit">Search</button>
      </form>
      <div id="player-list" style="max-height: 600px; overflow-y: scroll;">
        {% for player in players %}
          <div class="player-row" style="margin-bottom: 0.5em;">
            <span>{{ player.name }} ({{ player.position }}, {{ player.team }})</span>
            <button type="button" onclick="addPlayerToRoster('{{ player.id }}', '{{ player.position }}', '{{ player.name }}', '{{ player.team }}')">Add</button>
            <a href="{% url 'player-detail' player.id %}">Details</a>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
  <button type="submit">Create Team</button>
</form>
<script>
function addPlayerToRoster(playerId, position, name, team) {
  // Find the first empty slot for this position
  const slots = {
    'QB': ['QB'],
    'RB': ['RB1', 'RB2'],
    'WR': ['WR1', 'WR2'],
    'TE': ['TE'],
    'FLEX': ['FLEX'],
    'K': ['K'],
    'DEF': ['DEF'],
    'BENCH': ['BENCH1','BENCH2','BENCH3','BENCH4','BENCH5','BENCH6']
  };
  let slotKeys = slots[position] || [];
  if (slotKeys.length === 0 && position !== 'BENCH') {
    // Try FLEX or BENCH
    slotKeys = slots['FLEX'].concat(slots['BENCH']);
  }
  let assigned = false;
  for (let i = 0; i < slotKeys.length; i++) {
    let slot = slotKeys[i];
    let input = document.getElementById('slot_' + slot);
    let display = document.getElementById('slot_display_' + slot);
    if (input && input.value === "") {
      input.value = playerId;
      display.innerHTML = name + " (" + position + ", " + team + ")";
      assigned = true;
      break;
    }
  }
  if (!assigned) {
    // Try to fill any bench slot
    for (let i = 1; i <= 6; i++) {
      let slot = 'BENCH' + i;
      let input = document.getElementById('slot_' + slot);
      let display = document.getElementById('slot_display_' + slot);
      if (input && input.value === "") {
        input.value = playerId;
        display.innerHTML = name + " (" + position + ", " + team + ")";
        assigned = true;
        break;
      }
    }
  }
  if (!assigned) {
    alert("No available slot for this player!");
  }
}
</script>
{% endblock %}